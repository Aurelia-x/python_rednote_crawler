# 小红书自动发布脚本 (xhs_publisher.py) 开发问题与解决方案汇总

本文档记录了在开发 `xhs_publisher.py` 过程中遇到的主要技术问题、报错及其解决方案。

## 1. 浏览器自动化与环境问题

### 1.1 Windows 下 asyncio 管道报错
*   **问题描述**：脚本运行结束或中断时，终端频繁报出 `ValueError: I/O operation on closed pipe` 错误。这是 Windows 平台下 `asyncio` 事件循环关闭时，Playwright 底层管道未正确释放导致的已知问题。
*   **解决方案**：
    1.  在代码头部添加针对 Windows 平台的 `asyncio` 补丁，重写 `_ProactorBasePipeTransport.__del__` 和 `BaseSubprocessTransport.__del__` 方法，静默处理关闭时的异常。
    2.  优化 `main` 函数结构，使用 `async with async_playwright() as playwright:` 上下文管理器，确保 Playwright 资源在事件循环关闭前被正确回收。

### 1.2 浏览器启动后长时间空白/卡顿
*   **问题描述**：脚本一开始就启动浏览器，然后进行数据读取、AI 文案生成等耗时操作，导致浏览器界面长时间无响应，用户体验差。
*   **解决方案**：调整执行顺序。将所有数据准备工作（读取图片、解析 JSON、调用 AI API）提前到 `publisher.start()` 之前执行。浏览器一旦启动，数据已就绪，立即执行交互操作。

### 1.3 地理位置权限弹窗
*   **问题描述**：上传图片后，Chrome 浏览器会弹出“申请获取您的地理位置”的系统弹窗，干扰后续自动化流程。
*   **解决方案**：在浏览器上下文创建时（`browser.new_context`），通过 `add_init_script` 注入 JavaScript 代码，重写 `navigator.geolocation` 和 `navigator.permissions` 方法，强制返回“拒绝”状态，屏蔽弹窗。

## 2. 页面元素定位与交互问题

### 2.1 默认发布模式为“视频”
*   **问题描述**：跳转到创作中心发布页后，默认界面是“上传视频”。“上传图文”入口隐藏在左上角“发布笔记”按钮的悬停菜单中。
*   **解决方案**：
    1.  定位“发布笔记”文本元素。
    2.  调用 `.hover()` 方法触发下拉菜单。
    3.  等待菜单浮现后，定位“上传图文”并点击。

### 2.2 “发布”按钮定位歧义
*   **问题描述**：使用 `get_by_text("发布")` 会同时匹配到顶部导航栏和左侧菜单栏的多个元素，导致点击失败。
*   **解决方案**：改用更精确的语义化定位 `get_by_role("link", name="发布").first`，确保点击的是侧边栏的发布链接。

### 2.3 网络空闲等待超时
*   **问题描述**：使用 `wait_for_load_state("networkidle")` 在首页等待时，由于页面动态加载资源较多，经常导致超时。
*   **解决方案**：对于登录检查等非必须完全加载的场景，改用 `wait_until="domcontentloaded"`，提高脚本响应速度和稳定性。

## 3. 功能实现与逻辑优化

### 3.1 AI 文案生成消耗 Token
*   **问题描述**：在调试阶段频繁运行脚本，每次都调用千问 API 生成文案，造成 Token 浪费。
*   **解决方案**：在 `main` 函数中添加全局开关 `ENABLE_AI = False`。在开发调试 UI 交互时关闭 AI，仅在最终发布时开启。

### 3.2 内容类型声明自动化
*   **问题描述**：发布时需要手动勾选“内容来源声明”为“已在正文中自主标注”。
*   **解决方案**：实现了复杂的 UI 交互链：
    1.  `window.scrollBy` 滚动页面确保元素可见。
    2.  点击“添加内容类型声明”展开选项。
    3.  悬停“内容来源声明”触发二级菜单。
    4.  点击“已在正文中自主标注”。

### 3.3 图片与文案的对应
*   **问题描述**：如何确保发布的图片与 `annotations.json` 中的文案对应。
*   **解决方案**：使用 `note_id` 作为唯一标识。脚本根据 `note_id` 查找 `data_final/image/{note_id}` 下的图片，并在 `annotations.json` 中查找对应的元数据（标题、描述、原作者信息）。

## 4. 当前遗留/待关注项

*   **Cookie 有效性**：脚本依赖 `cookies.json` 进行免密登录。如果 Cookie 失效，需要重新运行 `get_cookies.py`（需配合 `xhs_crawler` 的登录逻辑）。
*   **选择器稳定性**：小红书网页版结构可能会更新，导致 CSS 选择器（如 `.title-container input`, `.tiptap.ProseMirror`）失效，需定期检查维护。
